# Validate Conventional Commits on PRs. Closes PR and sends email notification on failure.
name: Conventional Commits

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Conventional Commits
        id: validate
        run: |
          set +e
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          INVALID_COMMITS=""
          CC_PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\([^)]+\))?!?: .+'
          echo "Checking commits in range $BASE..$HEAD (PR branch commits only):"
          while IFS= read -r msg; do
            [ -z "$msg" ] && continue
            if [[ "$msg" =~ ^Merge ]]; then
              echo "  SKIP (merge): $msg"
              continue
            fi
            if echo "$msg" | grep -qE "$CC_PATTERN"; then
              echo "  PASS: $msg"
            else
              echo "  FAIL: $msg"
              INVALID_COMMITS="${INVALID_COMMITS}"$'\n'"- $msg"
            fi
          done < <(git log "$BASE..$HEAD" --pretty=format:"%s")
          if [ -n "$INVALID_COMMITS" ]; then
            echo "invalid=true" >> "$GITHUB_OUTPUT"
            echo "commits<<EOF" >> "$GITHUB_OUTPUT"
            printf '%s\n' "$INVALID_COMMITS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "One or more commits do not follow Conventional Commits:$INVALID_COMMITS"
          else
            echo "invalid=false" >> "$GITHUB_OUTPUT"
            echo "All commits follow Conventional Commits."
          fi

      - name: Close PR on invalid commits
        if: steps.validate.outputs.invalid == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr close ${{ github.event.pull_request.number }} --comment "This PR was closed because one or more commits do not follow [Conventional Commits](https://www.conventionalcommits.org/). Please use the format: \`type(scope)?: description\` (e.g. \`feat: add login\`, \`fix(auth): token expiry\`). Invalid commit(s): ${{ steps.validate.outputs.commits }}"
        working-directory: ${{ github.workspace }}

      - name: Collect notification recipients
        if: steps.validate.outputs.invalid == 'true'
        id: recipients
        env:
          # Repo owner email (set in Settings → Secrets and variables → Actions). GitHub does not expose user emails via API.
          REPO_OWNER_EMAIL: ${{ vars.REPO_OWNER_EMAIL || secrets.REPO_OWNER_EMAIL }}
        run: |
          # PR author: from event if available, else from first commit in PR
          PR_AUTHOR_EMAIL="${{ github.event.pull_request.user.email }}"
          if [ -z "$PR_AUTHOR_EMAIL" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
            PR_AUTHOR_EMAIL=$(git log "$BASE..$HEAD" --format='%ae' -1 2>/dev/null || true)
          fi
          # Build unique list: owner (from secret/var) + PR author; dedupe
          RECIPIENTS=""
          [ -n "$REPO_OWNER_EMAIL" ] && RECIPIENTS="$REPO_OWNER_EMAIL"
          if [ -n "$PR_AUTHOR_EMAIL" ]; then
            if [ -z "$RECIPIENTS" ]; then
              RECIPIENTS="$PR_AUTHOR_EMAIL"
            elif [ "$PR_AUTHOR_EMAIL" != "$REPO_OWNER_EMAIL" ]; then
              RECIPIENTS="${RECIPIENTS},${PR_AUTHOR_EMAIL}"
            fi
          fi
          echo "recipients=$RECIPIENTS" >> "$GITHUB_OUTPUT"
          echo "Sending to: ${RECIPIENTS:-'(none - set REPO_OWNER_EMAIL and/or ensure PR author email is available)'}"

      - name: Send failure notification (Ethereal)
        if: steps.validate.outputs.invalid == 'true'
        env:
          ETHEREAL_USER: ${{ secrets.ETHEREAL_USER }}
          ETHEREAL_PASS: ${{ secrets.ETHEREAL_PASS }}
          RECIPIENTS: ${{ steps.recipients.outputs.recipients }}
          PR_NUM: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          INVALID_COMMITS: ${{ steps.validate.outputs.commits }}
        run: |
          if [ -z "$RECIPIENTS" ]; then echo "No recipients, skipping email"; exit 0; fi
          if [ -z "$ETHEREAL_USER" ] || [ -z "$ETHEREAL_PASS" ]; then echo "Set ETHEREAL_USER and ETHEREAL_PASS secrets to send notifications"; exit 0; fi
          SUBJECT="PR closed: Conventional Commits validation failed"
          BODY="PR #${PR_NUM} was closed because some commits did not follow Conventional Commits. Repo: ${REPO}. Invalid commits: ${INVALID_COMMITS}"
          python3 -c "
          import smtplib, os
          from email.mime.text import MIMEText
          recipients = [e.strip() for e in os.environ.get('RECIPIENTS','').split(',') if e.strip()]
          if not recipients:
            exit(0)
          msg = MIMEText(os.environ.get('BODY',''))
          msg['Subject'] = os.environ.get('SUBJECT','')
          msg['From'] = os.environ.get('ETHEREAL_USER','')
          msg['To'] = ','.join(recipients)
          with smtplib.SMTP('smtp.ethereal.email', 587) as s:
            s.starttls()
            s.login(os.environ['ETHEREAL_USER'], os.environ['ETHEREAL_PASS'])
            s.sendmail(os.environ['ETHEREAL_USER'], recipients, msg.as_string())
          print('Notification sent via Ethereal; check inbox at https://ethereal.email')
          "

      - name: Fail job when commits are invalid
        if: steps.validate.outputs.invalid == 'true'
        run: exit 1
